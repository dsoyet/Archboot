#!/usr/bin/env bash
# SPDX-License-Identifier: GPL-2.0-only
# created by Tobias Powalowski <tpowa@archlinux.org>

build() {
    map add_module sd_mod? sr_mod? usb_storage? mmc_block? virtio_blk? vfat? \
        btrfs? zram? iso9660? loop? zstd? nls_cp437? nls_ascii? libcrc32c? cdrom?
    # pata, sata, scsi, nvme, usb, mmc, spi (for mmc mode), virtio
    map add_all_modules 'scsi/.*ata' '/(block|scsi|fusion|nvme)/' 'ata/[ps]ata_' \
            'ata/(ahci|pdc_adma|ata_piix|ata_generic)' '(_cs|sl811_hcd|isp116x_hcd)' \
            '/usb/host' '/drivers/usb/storage/' '/(drivers/mmc|tifm_)' \
            '/drivers/spi/' 'virtio'
    ### keyboard modules
    add_all_modules -f '(_cs|sl811_hcd|isp116x_hcd)' '/usb/host'
    add_all_modules '/hid/hid'
    add_module 'usbhid'
    add_all_modules '/input/(serio|keyboard)'
    ### kmx modules
    # AGP and DRM modules for GPUs
    map add_all_modules '/drivers/char/agp/' '/drivers/gpu/drm/'
    # modules that implement the privacy screen interface
    # TODO: Replace with dynamic lookup of modules that depend on the drm_privacy_screen_register symbol
    # See https://gitlab.archlinux.org/archlinux/mkinitcpio/mkinitcpio/-/issues/132
    map add_all_modules 'chromeos_privacy_screen?' 'thinkpad_acpi?'
    map add_binary bash sh blkid mount switch_root bsdcpio mkfs.btrfs setfont \
        /usr/lib/systemd/systemd-udevd udevadm systemd-tmpfiles kmod insmod modprobe \
        gzip uname cat cp dmesg grep ln ls mv rm umount lsblk rmmod cut sed find
    add_file "/usr/share/kbd/consolefonts/ter-v16n.psf.gz" "/consolefont-16.psf.gz"
    add_file "/usr/share/kbd/consolefonts/ter-v32n.psf.gz" "/consolefont-32.psf.gz"
    rules_d=/usr/lib/udev/rules.d
    map add_file ${rules_d}/50-udev-default.rules ${rules_d}/60-persistent-storage.rules \
        ${rules_d}/64-btrfs.rules ${rules_d}/80-drivers.rules /usr/lib/udev/ata_id \
        /usr/lib/udev/scsi_id
    add_file "/usr/share/archboot/base/init" "/init"
    map add_dir /mnt /cdrom /sysroot
    map add_file /etc/bash.bash_logout /etc/bash.bashrc /etc/profile /etc/shells
    # add default bash setup
    for i in .bashrc .bash_profile .bash_logout; do
        add_file  "/etc/skel/${i}" "/root/${i}"
    done
    # add custom bash options
    echo ". /root/.bashrc" >> "${BUILDROOT}/etc/bash.bashrc"
    echo ". /etc/profile.d/custom-bash-options.sh" >> "${BUILDROOT}/root/.bashrc"
    echo "alias reboot='echo b >/proc/sysrq-trigger'" >> "${BUILDROOT}/root/.bashrc"
    echo "alias poweroff='echo o >/proc/sysrq-trigger'" >> "${BUILDROOT}/root/.bashrc"
    echo "root:x:0:root" > "${BUILDROOT}/etc/group"
    echo "root:x:0:0:/root:/bin/bash" > "${BUILDROOT}/etc/passwd"
    add_file "/usr/share/archboot/base/etc/profile.d/custom-bash-options.sh" \
             "/etc/profile.d/custom-bash-options.sh"
    basic_config="os-release modprobe.d/modprobe.conf"
    for i in $basic_config; do
        add_file "/usr/share/archboot/base/etc/${i}" "/etc/${i}"
    done
}

help() {
    cat <<HELPEOF
Inital setup for archboot ISO booting.
HELPEOF
}

# vim: set ft=sh ts=4 sw=4 et:
