#!/usr/bin/bash
# SPDX-License-Identifier: GPL-2.0-only
# created by Tobias Powalowski <tpowa@archlinux.org>
# mount kernel filesystems
mount -t proc proc /proc -o nosuid,noexec,nodev
mount -t sysfs sys /sys -o nosuid,noexec,nodev
mount -t devtmpfs dev /dev -o mode=0755,nosuid
mount -t tmpfs run /run -o nosuid,nodev,mode=0755
if [ -e /sys/firmware/efi ]; then
    mount -t efivarfs efivarfs /sys/firmware/efi/efivars -o nosuid,nodev,noexec
fi
# initialize udev
kmod static-nodes --format=tmpfiles --output=/run/tmpfiles.d/kmod.conf
systemd-tmpfiles --prefix=/dev --create --boot
/usr/lib/systemd/systemd-udevd --daemon --resolve-names=never &>/dev/null
udevadm trigger --action=add --type=subsystems
udevadm trigger --action=add --type=devices
udevadm settle
udevadm control --exit
udevadm info --cleanup-db
echo -e "\e[1mInitializing\e[m \e[36mArchboot\e[m \e[1m- Arch Linux Environment:\e[m"
# it needs one echo before, in order to reset the consolefont!
setfont consolefont.psf.gz -C /dev/console
echo -e "\e[1mStep 1/4:\e[m Creating /dev/zram0 with zstd compression..."
modprobe zram &>/dev/null
echo "zstd" >/sys/block/zram0/comp_algorithm
echo "4G" >/sys/block/zram0/disksize
echo -e "\e[1mStep 2/4:\e[m Creating btrfs on /dev/zram0..."
mkfs.btrfs /dev/zram0 &>/dev/null
# use discard to get free RAM on delete!
mount -o discard /dev/zram0 /new_root &>/dev/null
# not all devices trigger autoload!
modprobe usb-storage &>/dev/null
echo -e "\e[1mStep 3/4:\e[m Searching for archboot rootfs on usb/hd device..."
echo -e "          Trying for 10 seconds..."
_COUNT=0
while ! mount UUID=1234-ABCD /mnt &>/dev/null; do
    sleep 1
    _COUNT=$((_COUNT+1))
    [[ "${_COUNT}" == 10 ]] && break
done
if ! [[ -f "/mnt/boot/initramfs-$(uname -m).img" ]] ; then
    echo -e "\e[1mStep 3/4:\e[m Searching for archboot rootfs on cdrom device..."
    mkdir /cdrom
    mount /dev/sr0 /cdrom &>/dev/null
    if ! mount /cdrom/efi.img /mnt &>/dev/null; then
        echo "ERROR: Didn't find a device with archboot rootfs!"
        echo "This needs further debugging. Please contact the archboot author."
        echo "Tobias Powalowski: tpowa@archlinux.org"
        /bin/sh
    fi
fi
cd /new_root || /bin/sh
echo -e "\e[1mStep 4/4:\e[m Copying archboot rootfs to /new_root..."
echo -e "          This may need some time..."
bsdcpio -i <"/mnt/boot/initramfs-$(uname -m).img"  &>/dev/null || /bin/sh
exec switch_root /new_root /init "$@"

# vim: set ft=sh ts=4 sw=4 et:
